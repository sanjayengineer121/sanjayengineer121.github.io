<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pay using UPI | Instant QR & App Payment</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #f8f9fa, #e3f2fd);
      color: #333;
    }
    .pay-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2rem;
      max-width: 960px;
      margin: auto;
    }
    .qr-box {
      border: 3px dashed #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      width: 100%;
      max-width: 350px;
      margin: auto;
    }
    .upi-apps img {
      border-radius: 12px;
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    .upi-apps img:hover {
      transform: scale(1.05);
    }
    .upi-btn {
      border: 2px solid #0d6efd;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0d6efd;
      font-weight: 600;
    }
    .upi-btn:hover {
      background-color: #0d6efd;
      color: white;
      text-decoration: none;
    }
    #downloadBtn {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="pay-card">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Pay via UPI</h2>
        <p class="text-muted">Scan QR or choose your UPI app to complete payment</p>
      </div>

      <div class="row g-4 justify-content-center">
        <div class="col-md-6 d-flex justify-content-center">
          <div class="qr-box" aria-label="QR code and download button">
            <div id="qrcode"></div>
            <p class="mt-3 text-muted small">Scan this code in any UPI app</p>
            <button id="downloadBtn" class="btn btn-primary btn-sm" aria-label="Download QR code with details">
              Download QR Code
            </button>
          </div>
        </div>

        <div class="col-md-6">
          <h5 class="text-secondary">Receiver Details</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              UPI ID: <strong id="payee">-</strong>
            </li>
            <li class="list-group-item">
              Name: <strong id="name">-</strong>
            </li>
            <li class="list-group-item">
              Amount: <strong id="amount">-</strong>
            </li>
            <li class="list-group-item">
              Note: <strong id="note">-</strong>
            </li>
          </ul>

          <div class="mt-4" id="buttons">
            <p class="fw-semibold">Pay using:</p>
            <div class="d-flex gap-3 upi-apps">
              <a id="paytm" class="text-decoration-none" target="_blank" rel="noopener">
                <img
                  src="https://play-lh.googleusercontent.com/k7yz57K2OxhNrPNKF2U18Zcv9rodOu7CfWh47U15FFUN8-_B0hQfXsM-BaLG0gOtvw=s180-rw"
                  width="60"
                  alt="Paytm"
                />
              </a>
              <a id="phonepe" class="text-decoration-none" target="_blank" rel="noopener">
                <img
                  src="https://play-lh.googleusercontent.com/6iyA2zVz5PyyMjK5SIxdUhrb7oh9cYVXJ93q6DZkmx07Er1o90PXYeo6mzL4VC2Gj9s=s180-rw"
                  width="60"
                  alt="PhonePe"
                />
              </a>
              <a id="gpay" class="text-decoration-none" target="_blank" rel="noopener">
                <img
                  src="https://play-lh.googleusercontent.com/HArtbyi53u0jnqhnnxkQnMx9dHOERNcprZyKnInd2nrfM7Wd9ivMNTiz7IJP6-mSpwk=s180-rw"
                  width="60"
                  alt="Google Pay"
                />
              </a>
              <a id="upi" class="text-decoration-none upi-btn" href="#" target="_blank" rel="noopener"
                >Other</a
              >
            </div>
          </div>
        </div>
      </div>

      <div class="text-center mt-5">
        <a href="create-link.html" class="btn btn-outline-primary rounded-pill px-4"
          >Create a Payment Link ðŸ”—</a
        >
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const vpa = params.get("pa") || "";
    const amount = params.get("am") || "";
    const name = params.get("pn") || "Receiver";
    const note = params.get("tn") || "";

    document.getElementById("payee").textContent = vpa || "-";
    document.getElementById("amount").textContent = amount ? `â‚¹${amount}` : "-";
    document.getElementById("name").textContent = name;
    document.getElementById("note").textContent = note || "-";

    const urlvalue = `pay?pa=${encodeURIComponent(
      vpa
    )}&pn=${encodeURIComponent(name)}&am=${encodeURIComponent(
      amount
    )}&tn=${encodeURIComponent(note)}&cu=INR`;

    document.getElementById("paytm").href = `paytmmp://${urlvalue}`;
    document.getElementById("phonepe").href = `phonepe://${urlvalue}`;
    document.getElementById("gpay").href = `tez://upi/${urlvalue}`;
    document.getElementById("upi").href = `upi://${urlvalue}`;

    const qr = new QRCodeStyling({
      width: 320,
      height: 320,
      type: "canvas",
      data: `upi://pay?pa=${vpa}&pn=${name}&am=${amount}&tn=${note}&cu=INR`,
      // Removed the image property to avoid tainting the canvas
      dotsOptions: {
        color: "#1e88e5",
        type: "rounded",
      },
      cornersSquareOptions: {
        color: "#1e88e5",
        type: "extra-rounded",
      },
      backgroundOptions: {
        color: "#ffffff",
      },
    });
    qr.append(document.getElementById("qrcode"));

    // Logos data to draw below QR in download
    const logos = [
      {
        src:
          "https://play-lh.googleusercontent.com/k7yz57K2OxhNrPNKF2U18Zcv9rodOu7CfWh47U15FFUN8-_B0hQfXsM-BaLG0gOtvw=s180-rw",
        alt: "Paytm",
      },
      {
        src:
          "https://play-lh.googleusercontent.com/6iyA2zVz5PyyMjK5SIxdUhrb7oh9cYVXJ93q6DZkmx07Er1o90PXYeo6mzL4VC2Gj9s=s180-rw",
        alt: "PhonePe",
      },
      {
        src:
          "https://play-lh.googleusercontent.com/HArtbyi53u0jnqhnnxkQnMx9dHOERNcprZyKnInd2nrfM7Wd9ivMNTiz7IJP6-mSpwk=s180-rw",
        alt: "Google Pay",
      },
    ];

    document.getElementById("downloadBtn").addEventListener("click", async () => {
      try {
        const canvasQR = document.querySelector("#qrcode canvas");
        if (!canvasQR) throw new Error("QR code canvas not found");

        // Create new canvas for combined image
        const width = 400;
        const height = 540; // enough for QR + text + logos
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        // White background
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, width, height);

        // Draw QR code canvas on top
        const qrX = (width - 320) / 2;
        ctx.drawImage(canvasQR, qrX, 10, 320, 320);

        // Draw text below QR
        ctx.fillStyle = "#1e88e5";
        ctx.font = "bold 18px Poppins, sans-serif";
        ctx.textAlign = "center";

        ctx.fillText(`UPI ID: ${vpa}`, width / 2, 350);
        ctx.fillText(`Name: ${name}`, width / 2, 380);
        ctx.fillText(`Amount: â‚¹${amount}`, width / 2, 410);

        // Draw app logos below text
        const logosY = 440;
        const logoSize = 50;
        const gap = 20;
        const totalWidth = logos.length * logoSize + (logos.length - 1) * gap;
        let startX = (width - totalWidth) / 2;

        // Draw logos asynchronously
        for (const logo of logos) {
          await new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "anonymous"; // avoid canvas taint
            img.onload = () => {
              ctx.drawImage(img, startX, logosY, logoSize, logoSize);
              startX += logoSize + gap;
              resolve();
            };
            img.onerror = () => {
              // fallback grey box on error
              ctx.fillStyle = "#ccc";
              ctx.fillRect(startX, logosY, logoSize, logoSize);
              startX += logoSize + gap;
              resolve();
            };
            img.src = logo.src;
          });
        }

        // Trigger download of combined image
        const dataURL = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataURL;
        a.download = "upi-payment-qr.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        alert("Failed to download QR code: " + error.message);
      }
    });
  </script>
</body>
</html>
